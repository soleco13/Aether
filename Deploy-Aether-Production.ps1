# Aether Production Deployment Script for Windows
# IP: 45.146.166.126
# Protocol: HTTP

Write-Host "üöÄ –ó–∞–ø—É—Å–∫ Aether –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º–µ –Ω–∞ 45.146.166.126" -ForegroundColor Green
Write-Host "=================================================" -ForegroundColor Green

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
Write-Host "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π..."

try {
    docker --version | Out-Null
    Write-Host "‚úÖ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Desktop –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞." -ForegroundColor Red
    exit 1
}

try {
    docker-compose --version | Out-Null
    Write-Host "‚úÖ Docker Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Docker Compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Compose –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞." -ForegroundColor Red
    exit 1
}

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ development —Å–µ—Ä–≤–∏—Å–æ–≤ –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã
Write-Host "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ development —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose down 2>$null

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è production
Write-Host "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö production –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose -f compose-production.yml down --remove-orphans 2>$null

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
Write-Host "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –¥–∞–Ω–Ω—ã—Ö..."
if (!(Test-Path "data")) { New-Item -ItemType Directory -Path "data" }
if (!(Test-Path "data/static")) { New-Item -ItemType Directory -Path "data/static" }
if (!(Test-Path "data/media")) { New-Item -ItemType Directory -Path "data/media" }

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ production
Write-Host "üèóÔ∏è –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ production —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose -f compose-production.yml up -d --build

if ($LASTEXITCODE -eq 0) {
    Write-Host "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!" -ForegroundColor Green
} else {
    Write-Host "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–∏—Å–æ–≤" -ForegroundColor Red
    exit 1
}

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
Write-Host "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫—É–Ω–¥)..."
Start-Sleep -Seconds 30

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
Write-Host "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
docker-compose -f compose-production.yml ps

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
Write-Host "üóÑÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
docker-compose -f compose-production.yml exec -T app-prod python manage.py migrate

# –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
Write-Host "üì¶ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
docker-compose -f compose-production.yml exec -T app-prod python manage.py collectstatic --noinput

Write-Host ""
Write-Host "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!" -ForegroundColor Green
Write-Host ""
Write-Host "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:" -ForegroundColor Cyan
Write-Host "   Frontend:  http://45.146.166.126:3000" -ForegroundColor White
Write-Host "   Backend:   http://45.146.166.126:8071" -ForegroundColor White
Write-Host "   Keycloak:  http://45.146.166.126:8083" -ForegroundColor White
Write-Host "   MinIO:     http://45.146.166.126:9001" -ForegroundColor White
Write-Host ""
Write-Host "üîë –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:" -ForegroundColor Cyan
Write-Host "   Keycloak Admin: admin / aether_keycloak_admin_2025" -ForegroundColor White
Write-Host "   MinIO:          aether_minio / aether_minio_password_2025" -ForegroundColor White
Write-Host ""
Write-Host "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:" -ForegroundColor Cyan
Write-Host "   –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:     docker-compose -f compose-production.yml logs -f" -ForegroundColor White
Write-Host "   –û—Å—Ç–∞–Ω–æ–≤–∫–∞:          docker-compose -f compose-production.yml down" -ForegroundColor White
Write-Host "   –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫:         docker-compose -f compose-production.yml restart" -ForegroundColor White
Write-Host ""
Write-Host "üéâ Aether –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!" -ForegroundColor Green 